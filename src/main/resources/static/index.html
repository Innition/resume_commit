<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>投递记录（Vue 版 Beta）</title>
    <link rel="stylesheet" href="./css/bootstrap.min.css" />
    <link rel="stylesheet" href="./css/bootstrap-icons.css" />
    <style>
        body { background: #f7f8fa; }
        .container { max-width: 1200px; }
        .process-grid { display: flex; flex-wrap: wrap; gap: 20px; }
        .process-item { width: 300px; background: #fff; border: 1px solid #eef0f3; border-radius: 10px; padding: 12px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
        .process-title { font-size: 16px; margin: 0; }
        .status-badge { font-size: 12px; padding: 2px 8px; border-radius: 999px; }
        .status-oc { background: #e7f7ef; color: #1e8e3e; }
        .status-pending { background: #eaf3ff; color: #0b57d0; }
        .status-rejected { background: #fde8e8; color: #b3261e; }
        .toolbar { display: flex; gap: 8px; align-items: center; }
        .toolbar .form-control { max-width: 240px; }

        /* TransitionGroup 动画类（name = card）*/
        .card-move { transition: transform .5s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-enter-active, .card-leave-active { transition: all .28s ease; }
        .card-enter-from, .card-leave-to { opacity: 0; transform: scale(0.98); }

        /* 新增飞入时的过渡（通过 JS 钩子设置 transform 起点，这里提供通用过渡时长） */
        .card-fly { transition: transform .8s cubic-bezier(0.4, 0, 0.2, 1), opacity .8s ease-out; will-change: transform, opacity; }
    </style>
</head>
<body>
<div id="app" class="py-3">
    <div class="container">
        <div class="d-flex align-items-center justify-content-between mb-3">
            <h5 class="mb-0">投递记录（Vue 版 Beta）</h5>
            <div class="toolbar">
                <span v-if="username" class="text-muted small me-2">欢迎，{{ username }}</span>
                <input v-model.trim="keyword" @keyup.enter="reload" class="form-control form-control-sm" placeholder="搜索公司/岗位/地点" />
                <select v-model="finalResult" class="form-select form-select-sm" style="width: 120px;">
                    <option value="">全部结果</option>
                                        <option value="OC">OC</option>
                    <option value="PENDING">PENDING</option>
                                        <option value="已挂">已挂</option>
                                    </select>
                <select v-model="sortMode" class="form-select form-select-sm" style="width: 140px;">
                    <option value="priority">按结果优先</option>
                    <option value="name">按公司名</option>
                                    </select>
                <button class="btn btn-primary btn-sm" @click="reload"><i class="bi bi-search"></i> 查询</button>
                <button class="btn btn-outline-secondary btn-sm" @click="clearFilters"><i class="bi bi-x-circle"></i> 清空</button>
                <button class="btn btn-success btn-sm" @click="openAddModal"><i class="bi bi-plus-circle"></i> 新增</button>
                <button class="btn btn-outline-dark btn-sm" @click="logout" v-if="username"><i class="bi bi-box-arrow-right"></i> 退出</button>
                <a class="btn btn-outline-secondary btn-sm" href="./index-legacy.html">返回旧版</a>
                            </div>
                        </div>
                        
        <div v-if="loading" class="text-muted py-4">加载中...</div>
        <div v-else>
            <div v-if="groupsSorted.length === 0" class="text-muted py-4">暂无记录</div>
            <TransitionGroup v-else name="card" tag="div" class="process-grid" :css="false" @enter="enterFromMouse" @after-enter="afterEnter">
                <div v-for="g in groupsSorted" :key="g.companyGroupId" class="process-item" :data-company-group-id="g.companyGroupId">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="process-title mb-0">{{ g.companyName }}</h6>
                        <div class="d-flex align-items-center" style="gap:6px;">
                            <span class="status-badge" :class="statusClass(g.finalResult)">{{ g.finalResult || '-' }}</span>
                            <button class="btn btn-sm btn-outline-primary" title="编辑" @click="openEditModal(g)" :disabled="!g.id"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-sm btn-outline-danger" title="删除代表记录" @click="deleteRecord(g.id)" :disabled="!g.id"><i class="bi bi-trash"></i></button>
                            </div>
                        </div>
                    <div class="small text-muted mb-1">岗位：{{ g.position || '-' }}</div>
                    <div class="small text-muted mb-1">地点：{{ g.baseLocation || '-' }}</div>
                    <div class="small text-muted">泡池时间：{{ g.poolDays || 0 }} 天</div>
                    </div>
            </TransitionGroup>
        </div>
    </div>

    <div class="container mt-4">
        <small class="text-muted">此页面为 Vue3 重构试验版，仅实现基础展示与筛选，后续逐步补齐动画与交互。</small>
                            </div>
                        </div>
                        
<!-- 简易新增记录模态（纯 Vue 实现） -->
<div v-if="addModalVisible" style="position: fixed; inset: 0; background: rgba(0,0,0,.35); display: flex; align-items: center; justify-content: center; z-index: 2000;">
    <div style="width: 520px; max-width: 92vw; background: #fff; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,.2);">
        <div style="padding: 12px 16px; border-bottom: 1px solid #eef0f3; display: flex; align-items: center; justify-content: space-between;">
            <strong>新增投递记录</strong>
            <button class="btn btn-sm btn-outline-secondary" @click="closeAddModal">关闭</button>
                                    </div>
        <div style="padding: 16px;">
            <div class="mb-3">
                <label class="form-label">公司名称</label>
                <input class="form-control" v-model.trim="newRecord.companyName" placeholder="必填" />
                                    </div>
            <div class="mb-3">
                <label class="form-label">岗位</label>
                <input class="form-control" v-model.trim="newRecord.position" placeholder="必填" />
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                    <label class="form-label">Base 地点</label>
                    <input class="form-control" v-model.trim="newRecord.baseLocation" />
                                    </div>
                                    <div class="col-md-6 mb-3">
                    <label class="form-label">投递时间</label>
                    <input type="datetime-local" class="form-control" v-model="newRecord.applyTime" />
                                    </div>
                                </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">结果</label>
                    <select class="form-select" v-model="newRecord.finalResult">
                        <option value="PENDING">PENDING</option>
                        <option value="OC">OC</option>
                        <option value="已挂">已挂</option>
                    </select>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">备注</label>
                <textarea class="form-control" rows="3" v-model.trim="newRecord.remarks" placeholder="可选"></textarea>
            </div>
            <div class="text-end">
                <button class="btn btn-secondary me-2" @click="closeAddModal">取消</button>
                <button class="btn btn-primary" @click="saveNewRecord" :disabled="savingNew">{{ savingNew ? '保存中...' : '保存' }}</button>
            </div>
        </div>
    </div>

    </div>

<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script>
    const API_BASE = '';

    function getAuthHeaders() {
        const token = localStorage.getItem('token');
        return token ? { 'Authorization': 'Bearer ' + token } : {};
    }

    function groupRecords(records) {
        const map = new Map();
        for (const r of records) {
            if (!map.has(r.companyGroupId)) map.set(r.companyGroupId, []);
            const list = map.get(r.companyGroupId);
            if (r.isPrimary) list.splice(0, 0, r); else list.push(r);
        }
        // 取每组第一条用于卡片展示
        const groups = [];
        for (const [companyGroupId, list] of map.entries()) {
            const top = list[0] || {};
            groups.push({
                companyGroupId,
                id: top.id,
                companyName: top.companyName,
                position: top.position,
                baseLocation: top.baseLocation,
                poolDays: top.poolDays,
                finalResult: top.finalResult
            });
        }
        return groups;
    }

    Vue.createApp({
        data() {
            return {
                loading: false,
                keyword: '',
                finalResult: '',
                allRecords: [],
                groups: [],
                sortMode: 'priority',
                // 动画：记录上次鼠标位置与本次新增分组
                lastMouse: { x: 0, y: 0 },
                addedIds: new Set(),
                username: '',
                addModalVisible: false,
                savingNew: false,
                newRecord: {
                    companyName: '',
                    position: '',
                    baseLocation: '',
                    applyTime: '',
                    finalResult: 'PENDING',
                    remarks: ''
                }
            };
        },
        mounted() {
            // 跟踪鼠标
            document.addEventListener('mousemove', (e) => {
                this.lastMouse.x = e.clientX;
                this.lastMouse.y = e.clientY;
            });
            // 简单鉴权：若无 token，提示并跳登录页（可根据实际路由调整）
            const token = localStorage.getItem('token');
            if (!token) {
                console.warn('未检测到登录 token');
            } else {
                try {
                    const payload = JSON.parse(atob(token.split('.')[1] || '')) || {};
                    this.username = payload.sub || '';
                } catch {}
            }
            this.reload();
        },
        computed: {
            groupsSorted() {
                const arr = [...this.groups];
                if (this.sortMode === 'name') {
                    return arr.sort((a, b) => (a.companyName || '').localeCompare(b.companyName || ''));
                }
                const getPriority = (r) => {
                    if (!r) return 999;
                    switch (r) {
                        case 'OC': return 1;
                        case 'PENDING': return 2;
                        default: return (String(r).includes('挂') ? 3 : 4);
                    }
                };
                return arr.sort((a, b) => {
                    const pa = getPriority(a.finalResult);
                    const pb = getPriority(b.finalResult);
                    if (pa !== pb) return pa - pb;
                    return (a.poolDays || 0) - (b.poolDays || 0);
                });
            }
        },
        methods: {
            statusClass(result) {
                if (result === 'OC') return 'status-oc';
                if (result === 'PENDING') return 'status-pending';
                if (result && result.includes('挂')) return 'status-rejected';
                return '';
            },
            async reload() {
                this.loading = true;
                try {
                    const res = await fetch(`${API_BASE}/records`, { headers: getAuthHeaders() });
                    const data = await res.json();
                    if (!data.success) throw new Error(data.message || '加载失败');
                    let records = data.data || [];
                    // 简易前端筛选（与现有逻辑保持基础一致）
                    if (this.keyword) {
                        const kws = this.keyword.split(/[,，]/).map(k => k.trim()).filter(Boolean);
                        records = records.filter(r => kws.some(kw =>
                            (r.companyName || '').toLowerCase().includes(kw.toLowerCase()) ||
                            (r.position || '').toLowerCase().includes(kw.toLowerCase()) ||
                            (r.baseLocation || '').toLowerCase().includes(kw.toLowerCase())
                        ));
                    }
                    if (this.finalResult) {
                        if (this.finalResult === '已挂') {
                            records = records.filter(r => (r.finalResult || '').includes('挂'));
                        } else {
                            records = records.filter(r => (r.finalResult || '') === this.finalResult);
                        }
                    }
                    // 计算新增分组ID集合
                    const prevIds = new Set(this.groups.map(g => g.companyGroupId));
                    const nextGroups = groupRecords(records);
                    const nextIds = new Set(nextGroups.map(g => g.companyGroupId));
                    const added = [];
                    nextIds.forEach(id => { if (!prevIds.has(id)) added.push(id); });
                    this.addedIds = new Set(added);

                    this.allRecords = records;
                    this.groups = nextGroups;
                } catch (e) {
                    console.error(e);
                    this.groups = [];
                    alert('数据加载失败，请检查登录状态或网络后重试');
                } finally {
                    this.loading = false;
                }
            },
            clearFilters() {
                this.keyword = '';
                this.finalResult = '';
                this.sortMode = 'priority';
                this.reload();
            },
            logout() {
                localStorage.removeItem('token');
                this.username = '';
                alert('已退出登录');
            },
            openEditModal(group) {
                if (!group || !group.id) return;
                this.newRecord = {
                    companyName: group.companyName || '',
                    position: group.position || '',
                    baseLocation: group.baseLocation || '',
                    applyTime: ''
                };
                this.editingId = group.id;
                this.addModalVisible = true;
            },
            openAddModal() {
                this.newRecord = { companyName: '', position: '', baseLocation: '', applyTime: '', finalResult: 'PENDING', remarks: '' };
                this.editingId = null;
                this.addModalVisible = true;
            },
            closeAddModal() {
                if (!this.savingNew) this.addModalVisible = false;
            },
            async saveNewRecord() {
                if (!this.newRecord.companyName || !this.newRecord.position) {
                    alert('请填写公司名称与岗位');
                    return;
                }
                this.savingNew = true;
                try {
                    const body = {
                        companyName: this.newRecord.companyName,
                        position: this.newRecord.position,
                        baseLocation: this.newRecord.baseLocation || null,
                        companyUrl: null,
                        applyTime: this.newRecord.applyTime || new Date().toISOString(),
                        testTime: null,
                        writtenExamTime: null,
                        currentStatus: null,
                        currentStatusDate: null,
                        finalResult: this.newRecord.finalResult || 'PENDING',
                        expectedSalaryType: null,
                        expectedSalaryValue: null,
                        remarks: this.newRecord.remarks || null,
                        interviews: []
                    };
                    const isEdit = !!this.editingId;
                    const url = isEdit ? `${API_BASE}/records/${this.editingId}` : `${API_BASE}/records`;
                    const method = isEdit ? 'PUT' : 'POST';
                    const res = await fetch(url, {
                        method,
                        headers: {
                            'Content-Type': 'application/json',
                            ...getAuthHeaders()
                        },
                        body: JSON.stringify(body)
                    });
                    if (!res.ok) throw new Error('创建失败');
                    await this.reload();
                    this.addModalVisible = false;
                } catch (e) {
                    console.error(e);
                    alert('保存失败，请稍后再试');
                } finally {
                    this.savingNew = false;
                }
            },
            async deleteRecord(id) {
                if (!id) return;
                if (!confirm('确认删除该记录？此操作不可撤销')) return;
                try {
                    const res = await fetch(`${API_BASE}/records/${id}`, {
                        method: 'DELETE',
                        headers: getAuthHeaders()
                    });
                    if (!res.ok) throw new Error('删除失败');
                    await this.reload();
                } catch (e) {
                    console.error(e);
                    alert('删除失败，请稍后再试');
                }
            },
            // 自定义进入过渡：对新增的卡片从鼠标位置飞入
            // el 为 .process-item 根元素；通过 this.addedIds 判断是否为新增
            enterFromMouse(el, done) {
                const id = el.getAttribute('data-company-group-id') || '';
                const isAdded = this.addedIds.has(id);
                if (!isAdded) {
                    el.classList.add('card-fly');
                    el.style.opacity = '0';
                    requestAnimationFrame(() => {
                        el.style.opacity = '1';
                        el.style.transform = 'translate(0, 0)';
                        const onEnd = () => { el.classList.remove('card-fly'); el.removeEventListener('transitionend', onEnd); done(); };
                        el.addEventListener('transitionend', onEnd);
                    });
                    return;
                }

                const grid = this.$el.querySelector('.process-grid');
                const gridRect = grid ? grid.getBoundingClientRect() : { left: 0, top: 0 };
                const finalRect = el.getBoundingClientRect();
                const targetX = finalRect.left - gridRect.left;
                const targetY = finalRect.top - gridRect.top;
                const startX = this.lastMouse.x - gridRect.left;
                const startY = this.lastMouse.y - gridRect.top;
                const deltaX = startX - targetX;
                const deltaY = startY - targetY;

                el.classList.add('card-fly');
                el.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
                el.style.opacity = '0.8';
                requestAnimationFrame(() => {
                    el.style.transform = 'translate(0, 0)';
                    el.style.opacity = '1';
                    const onEnd = () => {
                        el.classList.remove('card-fly');
                        el.removeEventListener('transitionend', onEnd);
                        done();
                    };
                    el.addEventListener('transitionend', onEnd);
                });
            },
            afterEnter(el) {
                el.style.transform = '';
                el.style.opacity = '';
            }
        }
    }).mount('#app');
</script>
</body>
</html>

